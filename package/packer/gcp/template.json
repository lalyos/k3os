{
    "variables": {
        "zone": "europe-west3-c",
        "project_id": "container-solutions-workshops",
        "k3os_version": "v0.2.0",
        "iso_url": "https://github.com/rancher/k3os/releases/download/v0.2.0/k3os-amd64.iso"
      },
    "builders": [
      {
        "image_name": "k3os-{{user `k3os_version`}}",
        "type": "googlecompute",
        "project_id": "{{user `project_id`}}",
        "source_image_family": "ubuntu-1804-lts",
        "ssh_username": "packer",
        "zone": "{{user `zone`}}"
      }
    ],
    "provisioners": [
        {
            "type": "file",
            "source": "./gcp.yaml",
            "destination": "/tmp/config.yaml"
        },
        {
            "type": "file",
            "source": "../../../install.sh",
            "destination": "/tmp/"
        },
        {
            "type": "shell",
            "inline":[
                "sudo apt-get update -y",
                "sudo apt-get install -y dosfstools parted",
                "sudo bash -x /tmp/install.sh --takeover --debug --tty ttyS0 --config /tmp/config.yaml --no-format $(findmnt / -o SOURCE -n) \"{{user `iso_url`}}\""
            ]
        },
        {
            "type": "shell",
            "inline":[
                "set -x; sudo systemd-run --on-active=3 --timer-property=AccuracySec=100ms sudo systemctl reboot --force --force; sync; echo Rebooting"
            ],
            "pause_after":"3m"
        }
    ]
  }